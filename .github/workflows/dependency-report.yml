
name: Dependency Report (.NET)

on:
  push:
    branches: [ i/3rd-party-dashboard ]
  schedule:
    - cron: "0 8 * * *"
  workflow_dispatch:

env:
  REPO_NAME: ${{ github.event.repository.name }}

jobs:
  sbom-and-dashboard:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: read
      
    steps:
      # ------------------------
      # Checkout this application
      # ------------------------
      - name: Checkout app repo
        uses: actions/checkout@v4
        with:
          ref: rework-added-RMS
          
      # ------------------------
      # Setup .NET
      # ------------------------
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x' 
      - name: Add Nuget Source
        run: dotnet nuget add source --username USERNAME --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/pa-nihr-crn/index.json"
      - name: Restore packages
        run: dotnet restore BPOR/BPOR.sln

      # ------------------------
      # SBOM (Syft) + Vulnerabilities (Grype)
      # ------------------------
      - name: Install CycloneDX .NET tool
        run: dotnet tool install --global CycloneDX
    
      - name: Generate SBOM (CycloneDX .NET)
        run: ~/.dotnet/tools/dotnet-CycloneDX BPOR/BPOR.sln -o . --filename sbom.json --output-format json
      
      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh \
            | sh -s -- -b /usr/local/bin
      - name: Scan SBOM with Grype (JSON)
        run: grype sbom:sbom.json -o json > grype-output.json

      # ------------------------
      # Built-in NuGet vulnerability & latest version data
      # ------------------------
      - name: Audit vulnerable NuGet packages (JSON)
        run: dotnet list BPOR/BPOR.sln package --vulnerable --include-transitive --format json > vulnerable-nuget.json

      - name: Detect NuGet packages (resolved & latest) as JSON
        run: dotnet list BPOR/BPOR.sln package --include-transitive --format json > raw-nuget.json

      - name: Transform raw-nuget.json → outdated-nuget.json
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Build outdated-nuget.json
        run: |
          node << 'EOF'
          const fs = require('fs');

          let text = '';
          try { text = fs.readFileSync('raw-nuget.json', 'utf8'); } catch {}
          let data = {};
          try { data = JSON.parse(text || '{}'); } catch {}

          function collectFrameworkPkgs(fw) {
            const list = [];
            if (Array.isArray(fw.topLevelPackages))   list.push(...fw.topLevelPackages);
            if (Array.isArray(fw.transitivePackages)) list.push(...fw.transitivePackages);
            return list;
          }
          // numeric-only compare, keeps lowest "current" and highest "latest"
          const splitVer = v => (v||'').split(/[^\d]+/).map(s => s === '' ? -1 : parseInt(s, 10)).filter(n => n >= 0);
          const cmp = (a,b) => {
            const A = splitVer(a), B = splitVer(b);
            const len = Math.max(A.length, B.length);
            for (let i=0;i<len;i++){
              const x = A[i] ?? 0, y = B[i] ?? 0;
              if (x !== y) return x - y;
            }
            return 0;
          };
          const pickHigher = (a,b) => (!a ? b : !b ? a : (cmp(a,b) >= 0 ? a : b));
          const pickLower  = (a,b) => (!a ? b : !b ? a : (cmp(a,b) <= 0 ? a : b));

          const result = {};
          for (const p of (data.projects || [])) {
            for (const fw of (p.frameworks || [])) {
              for (const pkg of collectFrameworkPkgs(fw)) {
                const id      = pkg.id || pkg.name;
                const current = pkg.resolvedVersion || pkg.version || null;
                const latest  = pkg.latestVersion  || pkg.latest  || null;
                if (!id || (!current && !latest)) continue;

                if (!result[id]) {
                  result[id] = { current, latest };
                } else {
                  result[id].current = pickLower(result[id].current, current);
                  result[id].latest  = pickHigher(result[id].latest, latest);
                }
              }
            }
          }

          fs.writeFileSync('outdated-nuget.json', JSON.stringify(result, null, 2));
          console.log('Wrote outdated-nuget.json with', Object.keys(result).length, 'packages');
          EOF

      # ------------------------
      # Select dashboard token (two possible secrets)
      # ------------------------
      - name: Select dashboard token
        run: |
          if [ -n "${{ secrets.DEPENDENCY_DASHBOARD_TOKEN }}" ]; then
            echo "DASHBOARD_TOKEN=${{ secrets.DEPENDENCY_DASHBOARD_TOKEN }}" >> $GITHUB_ENV
          elif [ -n "${{ secrets.CRNCC_AUTOMATION_PAT }}" ]; then
            echo "DASHBOARD_TOKEN=${{ secrets.CRNCC_AUTOMATION_PAT }}" >> $GITHUB_ENV
          else
            echo "❌ ERROR: No DEPENDENCY_DASHBOARD_TOKEN or CRNCC_AUTOMATION_PAT available."
            exit 1
          fi

      # ------------------------
      # Download unified builder (works for both Node & .NET repos)
      # ------------------------
      - name: Download build-summary.mjs from dashboard repo
        run: |
          curl -H "Authorization: token $DASHBOARD_TOKEN" \
            -L "https://raw.githubusercontent.com/PA-NIHR-CRN/dependency-dashboard/main/scripts/build-summary.mjs" \
            -o build-summary.mjs
          if grep -q "404: Not Found" build-summary.mjs; then
            echo "ERROR: build-summary.mjs not accessible"
            exit 1
          fi

      # ------------------------
      # Build summary.json (merges SBOM/Grype + NuGet data)
      # ------------------------
      - name: Build summary JSON
        run: node build-summary.mjs

      # ------------------------
      # Push json file → central dashboard
      # ------------------------
      - name: Checkout dashboard repo
        uses: actions/checkout@v4
        with:
          repository: PA-NIHR-CRN/dependency-dashboard
          token: ${{ env.DASHBOARD_TOKEN }}
          path: dashboard

      - name: Save report into dashboard/docs/data
        run: |
          mkdir -p dashboard/docs/data
          cp summary.json dashboard/docs/data/${REPO_NAME}.json
          cd dashboard
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/data/${REPO_NAME}.json
          git commit -m "Update dependency report for ${REPO_NAME}" || echo "No changes"
          git push