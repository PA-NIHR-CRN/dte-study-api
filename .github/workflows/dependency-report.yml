
name: Dependency Report

on:
  push:
    branches:
      - i/3rd-party-dashboard
  schedule:
    - cron: "0 8 * * *"
  workflow_dispatch:

env:
  REPO_NAME: ${{ github.event.repository.name }}

jobs:
  sbom-and-dashboard:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: read

    steps:
      # ------------------------
      # Checkout this application
      # ------------------------
      - name: Checkout app repo
        uses: actions/checkout@v4
        with:
          ref: rework-added-RMS

      # ------------------------
      # SBOM (Syft)
      # ------------------------
      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b /usr/local/bin
      - name: Generate SBOM
        run: syft dir:. -o cyclonedx-json > sbom.json

      # ------------------------
      # Vulnerabilities (Grype)
      # ------------------------
      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh \
            | sh -s -- -b /usr/local/bin
      - name: Scan vulnerabilities
        run: grype sbom:sbom.json -o json > grype-output.json

      # ------------------------
      # Collect version information (NuGet / .NET)
      # ------------------------
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'   # JSON output supported on SDK >= 7.0.200

      - name: Add Nuget Source
        run: dotnet nuget add source --username USERNAME --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/pa-nihr-crn/index.json"

      - name: Show NuGet sources
        run: dotnet nuget list source
        
      - name: Restore packages
        run: dotnet restore BPOR/BPOR.sln

      # Emit outdated packages as JSON
      - name: Detect outdated NuGet packages (JSON)
        run: |
          # Try the built-in CLI with JSON output (SDK >= 7.0.200)
          set -e
          dotnet package list --outdated --include-transitive --format json > raw.json

      # Convert dotnet JSON → the simple map your dashboard builder expects
      - name: Build outdated.json
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Transform raw.json to outdated.json
        run: |
          node << 'EOF'
          const fs = require('fs');

          // --------- Helpers (very loose semver-ish compare for numeric parts) ----------
          function splitVer(v){ return (v||'').split(/[^\d]+/).map(s => s === '' ? -1 : parseInt(s, 10)).filter(n => n >= 0); }
          function cmp(a,b){
            const A = splitVer(a), B = splitVer(b);
            const len = Math.max(A.length, B.length);
            for (let i=0;i<len;i++){
              const x = A[i] ?? 0, y = B[i] ?? 0;
              if (x !== y) return x - y;
            }
            return 0;
          }
          function pickHigher(a,b){ if (!a) return b; if (!b) return a; return cmp(a,b) >= 0 ? a : b; }
          function pickLower(a,b){ if (!a) return b; if (!b) return a; return cmp(a,b) <= 0 ? a : b; }

          // --------- Load "dotnet package list --outdated --format json" output ----------
          const text = fs.readFileSync('raw.json','utf8').trim();
          if (!text) { fs.writeFileSync('outdated.json', '{}'); process.exit(0); }

          let data;
          try { data = JSON.parse(text); } catch (e) {
            console.error('Failed to parse raw.json as JSON'); process.exit(0);
          }

          // Structure from dotnet JSON: { version, parameters, projects: [ { path, frameworks: [ { framework, topLevelPackages:[], transitivePackages:[] } ] } ] }
          const out = {}; // { packageId: { current, latest } }

          const pkgLists = (fw) => {
            const lists = [];
            if (Array.isArray(fw.topLevelPackages)) lists.push(...fw.topLevelPackages);
            if (Array.isArray(fw.transitivePackages)) lists.push(...fw.transitivePackages);
            return lists;
          };

          (data.projects || []).forEach(p => {
            (p.frameworks || []).forEach(fw => {
              pkgLists(fw).forEach(pkg => {
                const id = pkg.id || pkg.name;
                const current = pkg.resolvedVersion || pkg.version || null;
                const latest  = pkg.latestVersion  || pkg.latest  || null;
                if (!id || (!current && !latest)) return;

                if (!out[id]) {
                  out[id] = { current, latest };
                } else {
                  // If multiple projects/frameworks, keep the "oldest" current and the "newest" latest we see
                  out[id].current = pickLower(out[id].current, current);
                  out[id].latest  = pickHigher(out[id].latest, latest);
                }
              });
            });
          });

          fs.writeFileSync('outdated.json', JSON.stringify(out, null, 2));
          EOF

      # ------------------------
      # Select token (DEPENDENCY_DASHBOARD_TOKEN or CRNCC_AUTOMATION_PAT)
      # ------------------------
      - name: Select dashboard token
        run: |
          if [ -n "${{ secrets.DEPENDENCY_DASHBOARD_TOKEN }}" ]; then
            echo "Using DEPENDENCY_DASHBOARD_TOKEN"
            echo "DASHBOARD_TOKEN=${{ secrets.DEPENDENCY_DASHBOARD_TOKEN }}" >> $GITHUB_ENV
          elif [ -n "${{ secrets.CRNCC_AUTOMATION_PAT }}" ]; then
            echo "Using CRNCC_AUTOMATION_PAT"
            echo "DASHBOARD_TOKEN=${{ secrets.CRNCC_AUTOMATION_PAT }}" >> $GITHUB_ENV
          else
            echo "❌ ERROR: No DEPENDENCY_DASHBOARD_TOKEN or CRNCC_AUTOMATION_PAT available."
            exit 1
          fi
      
      
      # ------------------------
      # Download builder script
      # ------------------------
      - name: Download build-summary.mjs from dashboard repo
        run: |
          curl -H "Authorization: token $DASHBOARD_TOKEN" \
            -L "https://raw.githubusercontent.com/PA-NIHR-CRN/dependency-dashboard/main/scripts/build-summary.mjs" \
            -o build-summary.mjs
          if grep -q "404: Not Found" build-summary.mjs; then
            echo "ERROR: build-summary.mjs not accessible"
            exit 1
          fi

      # ------------------------
      # Build summary.json
      # ------------------------
      - name: Build summary JSON
        run: node build-summary.mjs

      # ------------------------
      # Push json file → central dashboard
      # ------------------------
      - name: Checkout dashboard repo
        uses: actions/checkout@v4
        with:
          repository: PA-NIHR-CRN/dependency-dashboard
          token: ${{ env.DASHBOARD_TOKEN }}
          path: dashboard

      - name: Save report into dashboard/docs/data
        run: |
          mkdir -p dashboard/docs/data
          cp summary.json dashboard/docs/data/${REPO_NAME}.json
          cd dashboard
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/data/${REPO_NAME}.json
          git commit -m "Update dependency report for ${REPO_NAME}" || echo "No changes"
          git push
